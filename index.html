# tsox-coach-v6
ACSM æ™ºèƒ½æ•™ç·´ App
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>T-SOX æ•™ç·´ â€” FITT-VP Final (Modified)</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;600;700;900&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root{
  --bg:#f3f6f5; --card:#ffffff; --primary:#2e7d32; --accent:#ff6f00; --muted:#616161;
  --nav-h:84px; --font-size:18px;
  --added-bg:#c8e6c9; --added-text:#2e7d32;
  --print-primary:#1b5e20; --print-accent:#ff8a65;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:'Noto Sans TC',sans-serif;background:var(--bg);color:#222;-webkit-font-smoothing:antialiased}
.header{background:linear-gradient(135deg,var(--primary),#1b5e20);color:white;padding:18px;border-radius:0 0 22px 22px;box-shadow:0 6px 20px rgba(27,94,32,0.25);position:sticky;top:0;z-index:60;display:flex;align-items:center;justify-content:space-between}
.header .title{font-weight:800;font-size:1.25rem}
.container{padding:16px;max-width:1100px;margin:0 auto;padding-bottom:140px}
.card{background:var(--card);border-radius:14px;padding:14px;margin-bottom:14px;box-shadow:0 6px 20px rgba(0,0,0,0.06)}
.label{font-weight:800;color:var(--muted);margin-bottom:8px;font-size:1.03rem}
.result{background:#f5fff6;border-radius:12px;padding:12px;border:1px solid #dff0e6;font-size:var(--font-size);line-height:1.5}
.small{font-size:0.95rem;color:var(--muted)}
.row{display:flex;gap:12px;align-items:center}
.controls{display:flex;gap:8px;margin-top:8px}
.button{padding:10px 14px;border-radius:12px;border:none;background:var(--primary);color:white;font-weight:700;font-size:0.95rem;cursor:pointer}
.button.secondary{background:#455a64}
.button.ghost{background:#fff;color:var(--muted);border:1px solid #eee}
.calendar-wrap{display:flex;gap:12px;flex-wrap:wrap}
.cal-panel{flex:1;min-width:320px}
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
.cal-cell{background:#fff;border-radius:10px;padding:10px;min-height:80px;border:1px solid #eee;position:relative;font-size:0.95rem}
.cal-cell .dateNum{font-weight:700;margin-bottom:8px}
.cal-dot{width:8px;height:8px;background:var(--accent);border-radius:50%;position:absolute;bottom:8px;left:50%;transform:translateX(-50%);display:none}
.cal-cell.has .cal-dot{display:block}
.badge{display:inline-block;padding:6px 10px;border-radius:10px;background:var(--primary);color:white;font-weight:800}
.hint{position:fixed;bottom:calc(var(--nav-h) + 6px);left:12px;right:12px;text-align:center;background:white;padding:10px;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,0.12);font-weight:700;z-index:50}
.console{position:fixed;left:12px;right:12px;bottom:160px;background:rgba(0,0,0,0.85);color:#00ffb2;padding:10px;border-radius:8px;font-family:monospace;font-size:0.92rem;max-height:140px;overflow:auto;z-index:40}
.fab-bar{position:fixed;bottom:12px;left:12px;right:12px;height:var(--nav-h);display:flex;align-items:center;justify-content:space-between;padding:10px;z-index:60}
.fab{width:72px;height:72px;border-radius:50%;background:linear-gradient(135deg,#43a047,var(--primary));border:4px solid white;color:white;font-size:30px;box-shadow:0 12px 30px rgba(0,0,0,0.2);display:flex;align-items:center;justify-content:center;cursor:pointer}
.fab.listening{background:var(--accent)}
.nav-card{flex:1;background:#fff;border-radius:12px;padding:8px;display:flex;align-items:center;justify-content:space-around;gap:8px;box-shadow:0 8px 20px rgba(0,0,0,0.06)}
.nav-btn{display:flex;flex-direction:column;align-items:center;color:#9e9e9e;font-weight:700;padding:6px 8px;border-radius:8px;cursor:pointer}
.nav-btn.active{color:var(--primary);background:rgba(46,125,50,0.06)}
.equip-info{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:white;padding:18px;border-radius:12px;box-shadow:0 12px 40px rgba(0,0,0,0.25);z-index:120;max-width:92%;display:none}
.equip-info h3{margin:0 0 8px 0}
.recommend-list{display:flex;flex-direction:column;gap:8px;margin-top:8px}
.reco-card{background:#fff;border-radius:10px;padding:10px;border:1px solid #eee;display:flex;justify-content:space-between;align-items:center}
.reco-left{max-width:68%}
.reco-meta{font-size:0.95rem;color:var(--muted)}
.chart-card{height:320px}
.toast{position:fixed;right:16px;bottom:110px;background:#323232;color:white;padding:10px 14px;border-radius:8px;z-index:200;opacity:0;transform:translateY(8px);transition:all .28s}
.toast.show{opacity:1;transform:translateY(0)}
.added-btn{background:var(--added-bg);color:var(--added-text);border:1px solid #a5d6a7}
.tab-page{display:none}
.tab-page.active{display:block}
.lang-row{display:flex;gap:8px;align-items:center}
.lang-btn{padding:6px 10px;border-radius:8px;border:1px solid #eee;background:white;cursor:pointer}
.lang-btn.active{background:#efebe9}
.add-all{margin-top:10px}
@media(max-width:760px){ .container{padding:12px} .cal-panel{min-width:100%} .cal-cell{min-height:74px} .console{display:none} .equip-info{width:92%} }
@media print {
  body{background:#fff}
  .fab-bar, .hint, .toast, .console, .nav-card { display:none !important; }
}
</style>
</head>
<body>
  <header class="header">
    <div class="title">T-SOX ç’°ç‹€é‹å‹•ç³»çµ± â€” æ™ºèƒ½æ•™ç·´</div>
    <div class="small" id="bmi">BMI: --</div>
  </header>

  <main class="container">
    <!-- SURVEY PAGE -->
    <section id="page-survey" class="tab-page active">
      <section class="card">
        <div class="label">å•è¨ºé€²åº¦</div>
        <div id="progress" class="large-text">å°šæœªé–‹å§‹</div>
        <div class="small" style="margin-top:8px">èªéŸ³ç‹€æ…‹ï¼š<span id="voiceState">å¾…å•Ÿå‹•</span></div>
      </section>

      <section class="card">
        <div class="label">å•è¨ºæ‘˜è¦ï¼ˆå³æ™‚ï¼‰</div>
        <pre id="answersView" class="result">å°šç„¡å•è¨ºè³‡æ–™</pre>
        <div style="margin-top:10px;display:flex;gap:8px;align-items:center">
          <button id="btnClear" class="button ghost">æ¸…é™¤å•è¨ºè³‡æ–™</button>
          <div style="margin-left:auto" class="lang-row">
            <div class="small">èªè¨€ï¼š</div>
            <button id="micZhBtn" class="lang-btn active">è¯èª</button>
            <!-- å°èªæŒ‰éˆ•å·²ç§»é™¤ï¼ˆä¾ä½¿ç”¨è€…æŒ‡ç¤ºï¼‰ -->
          </div>
        </div>
      </section>

      <section id="prescriptionCard" class="card" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div class="label">æ•™ç·´è™•æ–¹ï¼ˆåˆ†é …å»ºè­°ï¼‰</div>
            <div id="rxSummary" class="big"></div>
          </div>
          <div style="text-align:right">
            <div class="badge" id="rxBadge">å»ºè­°</div>
          </div>
        </div>

        <div style="margin-top:12px">
          <button id="addAllBtn" class="button add-all">ä¸€éµåŠ å…¥å…¨éƒ¨åˆ°ä»Šæ—¥è¡Œäº‹æ›†</button>
          <button id="exportAllBtn" class="button ghost" style="margin-left:8px">åŒ¯å‡ºå…¨éƒ¨è™•æ–¹ PDF</button>
        </div>

        <div id="rxPlan" style="margin-top:12px;font-size:1.02rem"></div>

        <div style="margin-top:10px">
          <div class="label">åˆ†é …å»ºè­°ï¼ˆæ¯é …å¯å–®ç¨åŠ å…¥è¡Œäº‹æ›†ï¼‰</div>
          <div id="recommendList" class="recommend-list"></div>
        </div>
      </section>
    </section>

    <!-- CALENDAR PAGE -->
    <section id="page-calendar" class="tab-page">
      <section class="card">
        <div class="label">è¡Œäº‹æ›†ï¼ˆæœˆæª¢è¦–ï¼‰</div>
        <div style="display:flex;gap:12px;align-items:center;margin-bottom:8px">
          <div style="display:flex;gap:8px;align-items:center">
            <button id="prevMonth" class="button ghost">â—€</button>
            <div id="calHeader" class="day-title large-text">--</div>
            <button id="nextMonth" class="button ghost">â–¶</button>
          </div>
          <div style="margin-left:auto" class="small">é»é¸æ—¥æœŸæŸ¥çœ‹ç•¶æ—¥è¨˜éŒ„ï¼ˆåŒ…å« METs & å¡è·¯é‡Œï¼‰</div>
        </div>
        <div class="calendar-wrap">
          <div class="cal-panel card" style="padding:10px">
            <div class="cal-grid" id="calGrid"></div>
          </div>
          <div class="side-panel card">
            <div class="label">ç•¶æ—¥è¨˜éŒ„</div>
            <div id="dayEvents" class="small">è«‹é»é¸æ—¥æœŸ</div>
          </div>
        </div>
      </section>
    </section>

    <!-- MET PAGE -->
    <section id="page-met" class="tab-page">
      <section class="card">
        <div class="label">æ¯é€± MET-min è¶¨å‹¢ï¼ˆè©³ç´°ï¼‰</div>
        <div class="card chart-card">
          <canvas id="weekChart" style="width:100%;height:100%"></canvas>
        </div>
      </section>
    </section>
  </main>

  <div id="hint" class="hint">æŒ‰ä¸€ä¸‹éº¥å…‹é¢¨ï¼ˆä¸€æ¬¡ï¼‰å–å¾—æ¬Šé™ä¸¦é–‹å§‹å•è¨ºï¼›éº¥å…‹é¢¨æœƒåœ¨æ‰€æœ‰å•é¡Œå•å®Œå¾Œè‡ªå‹•é—œé–‰ã€‚</div>

  <div id="console" class="console">[ç³»çµ±] æº–å‚™ä¸­â€¦</div>

  <div id="toast" class="toast">å·²åŠ å…¥è¡Œäº‹æ›†</div>

  <div class="fab-bar">
    <div class="nav-card">
      <div class="nav-btn active" id="tabSurveyBtn"><div style="font-size:20px">ğŸ©º</div><div style="font-size:12px">å•è¨º</div></div>
      <div class="nav-btn" id="tabCalendarBtn"><div style="font-size:20px">ğŸ“…</div><div style="font-size:12px">è¡Œäº‹æ›†</div></div>
      <div class="nav-btn" id="tabMetBtn"><div style="font-size:20px">ğŸ“ˆ</div><div style="font-size:12px">MET è¶¨å‹¢</div></div>
    </div>
    <div style="display:flex;align-items:center;gap:12px">
      <button id="micBtn" class="fab">ğŸ¤</button>
    </div>
  </div>

  <!-- equipment info modal -->
  <div id="equipInfo" class="equip-info">
    <h3 id="equipTitle">å™¨æèªªæ˜</h3>
    <div id="equipText">å…§å®¹</div>
    <div style="margin-top:12px;text-align:right"><button id="closeEquip" class="button ghost">é—œé–‰</button></div>
  </div>
<script>
/* ================= Final èªéŸ³æ ¸å¿ƒ (å·²ä¿®æ­£éº¥å…‹é¢¨ç©©å®šæ€§) ================= */
const steps = [
Â  {key:'gender', prompt:'è«‹å•æ‚¨çš„æ€§åˆ¥ï¼Œè«‹èªªã€Œç”·ã€æˆ–ã€Œå¥³ã€ã€‚', type:'select', map:{'ç”·':'male','å¥³':'female'}},
Â  {key:'age', prompt:'è«‹å•æ‚¨çš„å¹´é½¡å¹¾æ­²ï¼Ÿ', type:'number'},
Â  {key:'height', prompt:'è«‹å•æ‚¨çš„èº«é«˜å¤šå°‘å…¬åˆ†ï¼Ÿ', type:'number'},
Â  {key:'weight', prompt:'è«‹å•æ‚¨çš„é«”é‡å¤šå°‘å…¬æ–¤ï¼Ÿ', type:'number'},
Â  {key:'goal', prompt:'è«‹å•æ‚¨çš„ä¸»è¦é‹å‹•ç›®æ¨™ç‚ºä½•ï¼Ÿè«‹èªªã€Œæ¸›é‡ã€ã€ã€Œå¿ƒè‚ºã€ã€ã€Œè‚ŒåŠ›ã€æˆ–ã€Œå¥åº·ç¶­æŒã€ã€‚', type:'select', map:{'æ¸›é‡':'weight','å¿ƒè‚º':'cardio','è‚ŒåŠ›':'strength','å¥åº·':'maintain'}},
Â  {key:'current_days', prompt:'ç›®å‰æ¯é€±æ‚¨å¤§ç´„é‹å‹•å¹¾å¤©ï¼Ÿè«‹èªªæ•¸å­—ã€‚', type:'number'},
Â  {key:'future_days', prompt:'æœªä¾†æ‚¨å¸Œæœ›æ¯é€±å®‰æ’å¹¾å¤©é‹å‹•ï¼Ÿè«‹èªªæ•¸å­—ã€‚', type:'number'},
Â  {key:'experience', prompt:'æ‚¨çš„é‹å‹•ç¶“é©—ç‚ºä½•ï¼Ÿè«‹èªªã€Œç„¡ç¶“é©—ã€ã€ã€Œåˆå­¸ã€ã€ã€Œæœ‰ç¶“é©—ã€æˆ–ã€Œç«¶æŠ€ã€ã€‚', type:'text'},
Â  {key:'chronic', prompt:'æ˜¯å¦è¢«é†«å¸«è¨ºæ–·æœ‰æ…¢æ€§ç—…ï¼Ÿè«‹èªªã€Œæœ‰ã€æˆ–ã€Œæ²’æœ‰ã€ã€‚', type:'select', map:{'æœ‰':'yes','æ²’æœ‰':'no','ç„¡':'no'}},
Â  {key:'chronic_type', prompt:'è‹¥æœ‰ï¼Œè«‹èªªæ˜æ˜¯å“ªä¸€ç¨®æ…¢æ€§ç—…ï¼Œä¾‹å¦‚ã€Œå¿ƒè¡€ç®¡ã€ã€ã€Œé«˜è¡€å£“ã€ã€ã€Œç³–å°¿ç—…ã€ã€ã€Œè…è‡Ÿã€ç­‰ã€‚', type:'text'},
Â  {key:'asthma', prompt:'æ˜¯å¦æœ‰æ°£å–˜æˆ–å‘¼å¸ç›¸é—œå•é¡Œï¼Ÿè«‹èªªã€Œæœ‰ã€æˆ–ã€Œæ²’æœ‰ã€ã€‚', type:'select', map:{'æœ‰':'yes','æ²’æœ‰':'no'}},
Â  {key:'knee', prompt:'è†è“‹æ˜¯å¦æœƒç–¼ç—›ï¼Ÿè«‹èªªã€Œè†è“‹ç—›ã€æˆ–ã€Œæ²’æœ‰ã€ã€‚', type:'select', map:{'è†è“‹ç—›':'yes','ç—›':'yes','æœ‰ç—›':'yes','æ²’æœ‰':'no','æ²’ç—›':'no'}},
Â  {key:'goal_weeks', prompt:'æ‚¨çš„ç›®æ¨™å¸Œæœ›åœ¨å¹¾é€±å…§é”æˆï¼Ÿè«‹èªªæ•¸å­—ï¼Œä¾‹å¦‚åäºŒã€‚', type:'number'}
];

let currentIndex = 0;
let answers = {};
let recognition = null;
let isListening = false;
let autoRecording = false;
let suppressRecognition = false;
let waitingForTTS = false;
let currentLang = 'cmn-Hant-TW'; 
const synth = window.speechSynthesis;

/* DOM refs */
const consoleEl = document.getElementById('console');
const micBtn = document.getElementById('micBtn');
const hintEl = document.getElementById('hint');
const answersView = document.getElementById('answersView');
const progressEl = document.getElementById('progress');
const voiceState = document.getElementById('voiceState');
const prescriptionCard = document.getElementById('prescriptionCard');
const rxSummary = document.getElementById('rxSummary');
const rxPlan = document.getElementById('rxPlan');
const recommendList = document.getElementById('recommendList');
const calGrid = document.getElementById('calGrid');
const calHeader = document.getElementById('calHeader');
const dayEvents = document.getElementById('dayEvents');
const prevMonth = document.getElementById('prevMonth');
const nextMonth = document.getElementById('nextMonth');
const addAllBtn = document.getElementById('addAllBtn');
const exportAllBtn = document.getElementById('exportAllBtn');
const weekCtx = document.getElementById('weekChart').getContext('2d');
const weekCtxSmall = document.getElementById('weekChartSmall').getContext('2d');
const equipInfo = document.getElementById('equipInfo');
const equipTitle = document.getElementById('equipTitle');
const equipText = document.getElementById('equipText');
const closeEquip = document.getElementById('closeEquip');
const micZhBtn = document.getElementById('micBtnZh');
const micTwBtn = document.getElementById('micBtnTw');
let weekChart = null, weekChartSmall = null;
let viewDate = new Date();


/* ---------- Utility Functions ---------- */
function log(msg, err=false){ const t=new Date().toLocaleTimeString(); consoleEl.innerText = `[${t}] ${msg}\n` + consoleEl.innerText; }
function showToast(message) {
Â  const container = document.getElementById('toast-container');
Â  const toast = document.createElement('div');
Â  toast.className = 'toast';
Â  toast.textContent = message;
Â  container.appendChild(toast);
Â  setTimeout(() => { toast.classList.add('show'); }, 10);
Â  setTimeout(() => { toast.classList.remove('show'); }, 3000);
Â  setTimeout(() => { container.removeChild(toast); }, 3500);
}
function updateProgress(){ progressEl.innerText = `ç¬¬ ${Math.min(currentIndex+1, steps.length)} é¡Œ / ${steps.length} é¡Œ`; }
function prettyAnswers(){
Â  let s = '';
Â  s += `ğŸ‘¤ æ€§åˆ¥ï¼š${answers.gender==='male'?'ç”·æ€§':answers.gender==='female'?'å¥³æ€§':'æœªå¡«'}\n`;
Â  if(answers.age) s += `ğŸ‚ å¹´é½¡ï¼š${answers.age} æ­²\n`;
Â  if(answers.height) s += `ğŸ“ èº«é«˜ï¼š${answers.height} å…¬åˆ†\n`;
Â  if(answers.weight) s += `âš– é«”é‡ï¼š${answers.weight} å…¬æ–¤\n`;
Â  if(answers.goal) s += `ğŸ¯ é‹å‹•ç›®æ¨™ï¼š${answers.goal}\n`;
Â  if(answers.current_days) s += `ğŸ“… ç›®å‰æ¯é€±é‹å‹•ï¼š${answers.current_days} å¤©\n`;
Â  if(answers.future_days) s += `ğŸ“… å¸Œæœ›æ¯é€±å®‰æ’ï¼š${answers.future_days} å¤©\n`;
Â  if(answers.experience) s += `ğŸ‹ï¸ ç¶“é©—ï¼š${answers.experience}\n`;
Â  s += `ğŸ’Š æ…¢æ€§ç—…ï¼š${answers.chronic==='yes'?'æœ‰':'æ²’æœ‰'}\n`;
Â  if(answers.chronic==='yes' && answers.chronic_type) s += `ã€€ã€€é¡å‹ï¼š${answers.chronic_type}\n`;
Â  s += `ğŸŒ¬ æ°£å–˜ï¼š${answers.asthma==='yes'?'æœ‰':'æ²’æœ‰'}\n`;
Â  s += `ğŸ¦µ è†è“‹ç–¼ç—›ï¼š${answers.knee==='yes'?'æœ‰':'æ²’æœ‰'}\n`;
Â  if(answers.goal_weeks) s += `â³ ç›®æ¨™æœŸç¨‹ï¼š${answers.goal_weeks} é€±\n`;
Â  answersView.innerText = s || 'å°šç„¡å•è¨ºè³‡æ–™';
Â  if(answers.height && answers.weight){
Â  Â  const h = Number(answers.height); const w = Number(answers.weight);
Â  Â  if(h && w) document.getElementById('bmi').innerText = 'BMI: ' + (w/((h/100)**2)).toFixed(1);
Â  }
}

/* ---------- SpeechRecognition: Single-Shot Turn-Taking Fix ---------- */
function initRecognition(lang){
Â  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
Â  if(!SR){ alert('ç€è¦½å™¨ä¸æ”¯æ´ Web Speech APIï¼Œè«‹ä½¿ç”¨ Chrome ä¸¦æ–¼ HTTPS åŸ·è¡Œ'); log('ä¸æ”¯æ´ SpeechRecognition', true); return false; }
Â  
Â  if(recognition) { try { recognition.stop(); } catch(e) {} recognition = null; }
Â  
Â  recognition = new SR();
Â  recognition.lang = lang || currentLang;
Â  recognition.interimResults = false;
Â  recognition.continuous = false; // é—œéµä¿®æ­£ï¼šå–®å¥æ¨¡å¼
Â  
Â  recognition.onstart = ()=>{ 
Â  Â  isListening = true; 
Â  Â  micBtn.classList.add('listening'); 
Â  Â  voiceState.innerText=`éŒ„éŸ³ä¸­ (${recognition.lang})`; log('éŒ„éŸ³å•Ÿå‹•'); 
Â  };
Â  recognition.onresult = (e)=>{
Â  Â  if(suppressRecognition) { log('suppressRecognition - å¿½ç•¥æ­¤çµæœ'); return; }
Â  Â  const text = e.results[e.results.length-1][0].transcript.trim();
Â  Â  log('è¾¨è­˜åˆ°èªéŸ³: ' + text);
Â  Â  processAnswer(text); 
Â  };
Â  recognition.onerror = (ev)=>{ 
Â  Â  log('è¾¨è­˜éŒ¯èª¤: ' + ev.error, true);
Â  Â  // éŒ¯èª¤ç™¼ç”Ÿæ™‚ï¼Œå˜—è©¦ç¹¼çºŒæµç¨‹è€Œä¸æ˜¯ç›´æ¥ä¸­æ–·
Â  Â  if(autoRecording && currentIndex < steps.length){
Â  Â  Â  setTimeout(()=>{ continueDiagnosis(); }, 500); 
Â  Â  }
Â  };
Â  recognition.onend = ()=>{
Â  Â  isListening = false; 
Â  Â  micBtn.classList.remove('listening'); 
Â  Â  log('recognition.onend');
Â  Â  
Â  Â  // é—œéµä¿®æ­£ï¼šç•¶ session çµæŸï¼Œä½† TTS æ²’ç™¼è²ï¼Œè¡¨ç¤ºæ˜¯è¶…æ™‚ï¼Œå¿…é ˆé‡æ–°å•Ÿå‹•
Â  Â  if(autoRecording && currentIndex < steps.length && !waitingForTTS){
Â  Â  Â  log('åµæ¸¬åˆ°è¶…æ™‚æˆ–éæ­£å¸¸çµæŸï¼Œå˜—è©¦é‡æ–°å•Ÿå‹•ç™¼å•æµç¨‹...');
Â  Â  Â  setTimeout(()=>{ continueDiagnosis(); }, 300);
Â  Â  } else if (!autoRecording) {
Â  Â  Â  voiceState.innerText = 'ç­‰å¾…ä¸­';
Â  Â  }
Â  };
Â  currentLang = lang;
Â  return true;
}

/* å¼·åŒ–æµç¨‹æ§åˆ¶ï¼šè¶…æ™‚æˆ–éŒ¯èª¤æ™‚å›åˆ°ç™¼å•ç’°ç¯€ */
function continueDiagnosis(){
Â  if(currentIndex < steps.length){
Â  Â  const nextQ = steps[currentIndex].prompt;
Â  Â  log('è‡ªå‹•é‡å•Ÿå•è¨ºã€‚å•é¡Œï¼š' + nextQ);
Â  Â  speak(nextQ, ()=> { 
Â  Â  Â  // If TTS ends, mic should start immediately via speak() function's logic
Â  Â  Â  voiceState.innerText = 'éŒ„éŸ³ä¸­...ï¼ˆå†æ¬¡è©¢å•ï¼‰';
Â  Â  });
Â  } else {
Â  Â  log('å•è¨ºå®Œæˆï¼Œå·²åœæ­¢å¾ªç’°');
Â  Â  autoRecording = false;
Â  Â  voiceState.innerText = 'å·²çµæŸ';
Â  Â  consoleEl.style.display = 'none';
Â  Â  hintEl.style.display = 'none';
Â  }
}


/* ---------- TTS ---------- */
function speak(text, onend){
Â  waitingForTTS = true;
Â  suppressRecognition = true;
Â  
Â  try{ recognition && recognition.stop(); } catch(e){}

Â  const u = new SpeechSynthesisUtterance(text);
Â  const voices = speechSynthesis.getVoices();
Â  let chosen = voices.find(v => v.lang && v.lang.toLowerCase().startsWith('zh-tw')) || voices[0];
Â  u.voice = chosen;
Â  u.lang = chosen?.lang || 'zh-TW';
Â  u.rate = 1.05;
Â  
Â  u.onend = ()=>{
Â  Â  waitingForTTS = false;
Â  Â  suppressRecognition = false;
Â  Â  log('TTS çµæŸ: ' + text);
Â  Â  
Â  Â  if(typeof onend === 'function') onend();
Â  Â  
Â  Â  // Auto start recognition after TTS finished
Â  Â  if(autoRecording && currentIndex < steps.length){
Â  Â  Â  setTimeout(()=>{ 
Â  Â  Â  Â  try{ recognition.start(); } catch(e){ log('restart fail after TTS: ' + (e.message||e), true); } 
Â  Â  Â  }, 300);
Â  Â  }
Â  };
Â  synth.cancel(); synth.speak(u);
}

/* ---------- parsing helpers (same as previous) ---------- */
function parseChineseNumber(text){
Â  const m = text.match(/\d+/); if(m) return Number(m[0]);
Â  const map = {'é›¶':0,'ä¸€':1,'äºŒ':2,'å…©':2,'ä¸‰':3,'å››':4,'äº”':5,'å…­':6,'ä¸ƒ':7,'å…«':8,'ä¹':9,'å':10,'ç™¾':100};
Â  let val=0,t=0,found=false;
Â  for(const ch of text){ if(map[ch]!==undefined){ found=true; if(map[ch]===10||map[ch]===100){ if(t===0) t=1; val += t * map[ch]; t=0;} else { t = t*10 + map[ch]; } } }
Â  val += t; return found ? val : null;
}
function normalize(t){ return t.replace(/\s+/g,'').replace(/[ï¼Œã€‚,.ã€]/g,'').toLowerCase(); }

/* ---------- processAnswer (core logic) ---------- */
function processAnswer(recText){
Â  if(currentIndex >= steps.length) return;
Â  const step = steps[currentIndex];
Â  let val = null;
Â  const raw = recText.trim();
Â  const c = normalize(raw);

Â  if(step.type==='number'){ val = parseChineseNumber(c); }
Â  else if(step.type==='select' && step.map){
Â  Â  for(const k in step.map) if(c.includes(k)) { val = step.map[k]; break; }
Â  Â  if(val===null){
Â  Â  Â  if(c.includes('æœ‰')) val='yes';
Â  Â  Â  if(c.includes('æ²’æœ‰')||c.includes('ç„¡')) val='no';
Â  Â  Â  if(c.includes('æ¸›é‡')) val='weight';
Â  Â  Â  if(c.includes('å¿ƒè‚º')) val='cardio';
Â  Â  Â  if(c.includes('è‚ŒåŠ›')) val='strength';
Â  Â  Â  if(c.includes('ç¶­æŒ')) val='maintain';
Â  Â  Â  if(c.includes('ç”·')) val='male';
Â  Â  Â  if(c.includes('å¥³')) val='female';
Â  Â  }
Â  } else { val = raw; }

Â  if(val===null && step.type==='number'){
Â  Â  const num = parseFloat(raw);
Â  Â  if(!isNaN(num)) val = num;
Â  }

Â  if(val===null){
Â  Â  log('ç„¡æ³•è§£æç­”æ¡ˆï¼Œè«‹å†èªªä¸€æ¬¡'); speak('æŠ±æ­‰ï¼Œæ²’è½æ¸…æ¥šï¼Œè«‹å†èªªä¸€æ¬¡ã€‚'); return;
Â  }

Â  answers[step.key] = val;
Â  prettyAnswers();

Â  if(step.key === 'chronic' && val === 'no'){
Â  Â  delete answers['chronic_type'];
Â  Â  currentIndex++; // skip chronic_type
Â  }

Â  currentIndex++;
Â  updateProgress();

Â  // Stop recognition temporarily before speaking next question (will restart via TTS.onend)
Â  try{ recognition && recognition.stop(); } catch(e){}

Â  if(currentIndex < steps.length){
Â  Â  const nextQ = steps[currentIndex].prompt;
Â  Â  log('ä¸‹ä¸€é¡Œï¼š' + nextQ);
Â  Â  speak(nextQ);
Â  } else {
Â  Â  log('å•è¨ºå®Œæˆï¼Œç”Ÿæˆè™•æ–¹...');
Â  Â  try{ recognition && recognition.stop(); } catch(e){}
Â  Â  autoRecording = false;
Â  Â  voiceState.innerText = 'å·²çµæŸ';
Â  Â  speak('å•è¨ºå®Œæˆï¼Œæ•™ç·´æ­£åœ¨ç‚ºæ‚¨ç”Ÿæˆå»ºè­°ã€‚');
Â  Â  
Â  Â  setTimeout(()=> generatePrescription(), 700);
Â  Â  
Â  Â  consoleEl.style.display = 'none';
Â  Â  hintEl.style.display = 'none';
Â  }
}


/* --- Other functions are retained from the previous code, as the primary fix was in the voice loop --- */

/* ---------- equipment info content (retained) ---------- */
const equipInfos = {
Â  'è·‘æ­¥æ©Ÿ': { title:'è·‘æ­¥æ©Ÿ - æ³¨æ„äº‹é …', text:'æŠ¬é ­ã€æ ¸å¿ƒç©©å®šã€æ­¥å¹…é©ä¸­ã€‚è‹¥è†è“‹ç—›æˆ–å¿ƒè¡€ç®¡ç–¾ç—…é ˆä¿å®ˆï¼›ç†±èº« 8-10 åˆ†é˜ï¼Œå¡åº¦/é€Ÿåº¦é€æ­¥å¢åŠ ã€‚' },
Â  'æ©¢åœ“æ©Ÿ': { title:'æ©¢åœ“æ©Ÿ - æ³¨æ„äº‹é …', text:'ä½è¡æ“Šå™¨æï¼Œä¿æŒè¸æ¿å¹³é †èˆ‡æ‰‹æŠŠç©©å®šï¼Œé©åˆè†è“‹ä¸é©è€…ã€‚' },
Â  'åˆ’èˆ¹æ©Ÿ': { title:'åˆ’èˆ¹æ©Ÿ - æ³¨æ„äº‹é …', text:'å‹•ä½œé †åºï¼šè…¿â†’è»€å¹¹â†’æ‰‹ã€‚æ ¸å¿ƒæ”¶ç·Šï¼Œé¿å…ç”¨è‚©è†€æ‹‰ã€‚è…°ç—›è€…é™ä½é˜»åŠ›ã€‚' },
Â  'ç«‹å¼è…³è¸è»Š': { title:'ç«‹å¼è…³è¸è»Š - æ³¨æ„äº‹é …', text:'é©åˆé–“æ­‡è¨“ç·´ï¼Œåº§æ¤…èª¿æ•´æ­£ç¢ºï¼Œé¿å…è†è“‹å…§æ‰£ã€‚' },
Â  'è‡¥å¼è…³è¸è»Š': { title:'è‡¥å¼è…³è¸è»Š - æ³¨æ„äº‹é …', text:'éå¸¸ä½è¡æ“Šï¼Œé©åˆå¾©å¥èˆ‡åˆå­¸è€…ï¼Œåº§æ¤…èˆ‡é èƒŒè¦æ”¯æ’è…°éƒ¨ã€‚' }
};
function showEquipInfoByName(name){
Â  const info = equipInfos[name] || {title:name, text:'ç„¡é¡å¤–è³‡è¨Š'};
Â  equipTitle.innerText = info.title;
Â  equipText.innerText = info.text;
Â  equipInfo.style.display = 'block';
}
closeEquip.addEventListener('click', ()=> equipInfo.style.display = 'none');

/* ---------- prescription generation & display (retained) ---------- */
function generatePrescription(){
Â  const h = Number(answers.height) || null;
Â  const w = Number(answers.weight) || 70;
Â  const currDays = Number(answers.current_days) || 0;
Â  const futureDays = Number(answers.future_days) || currDays;
Â  const exp = (answers.experience||'').toString().toLowerCase();
Â  const chronic = answers.chronic==='yes';
Â  const chronic_type = (answers.chronic_type||'').toString().toLowerCase();
Â  const knee = answers.knee==='yes';
Â  const asthma = answers.asthma==='yes';
Â  const goal = answers.goal || 'ç¶­æŒ';
Â  const weeks = Number(answers.goal_weeks) || 12;

Â  let allowed = ['è·‘æ­¥æ©Ÿ','æ©¢åœ“æ©Ÿ','åˆ’èˆ¹æ©Ÿ','ç«‹å¼è…³è¸è»Š','è‡¥å¼è…³è¸è»Š'];
Â  if(knee) allowed = allowed.filter(x=> x!=='è·‘æ­¥æ©Ÿ' && x!=='ç«‹å¼è…³è¸è»Š');
Â  if(chronic){
Â  Â  if(chronic_type.includes('å¿ƒ')||chronic_type.includes('é«˜è¡€å£“')||chronic_type.includes('å¿ƒè¡€ç®¡')){
Â  Â  Â  allowed = allowed.filter(x=> x!=='è·‘æ­¥æ©Ÿ');
Â  Â  }
Â  }
Â  if(asthma) allowed = allowed.filter(x=> x!=='è·‘æ­¥æ©Ÿ');
Â  if(allowed.length===0) allowed=['è‡¥å¼è…³è¸è»Š','æ©¢åœ“æ©Ÿ'];

Â  let intensity='ä¸­ç­‰å¼·åº¦', rpe='RPE 4-6', totalTime=30;
Â  if(exp.includes('ç„¡') || currDays<=1){ intensity='ä¸­ä½å¼·åº¦'; rpe='RPE 3-5'; totalTime=25; }
Â  else if(exp.includes('åˆ') || currDays===2 || currDays===3){ intensity='ä¸­ç­‰å¼·åº¦'; rpe='RPE 4-6'; totalTime=30; }
Â  else if(exp.includes('æœ‰') || currDays>=4){ intensity='ä¸­é«˜å¼·åº¦'; rpe='RPE 5-7'; totalTime=35; }
Â  else if(exp.includes('ç«¶') || currDays>=5){ intensity='é«˜å¼·åº¦'; rpe='RPE 6-8'; totalTime=40; }
Â  if(chronic || asthma || knee){ totalTime = Math.max(20, Math.round(totalTime*0.8)); rpe='RPE 3-5ï¼ˆä¿å®ˆï¼‰'; intensity='ä½åˆ°ä¸­ç­‰ï¼ˆä¿å®ˆï¼‰'; }

Â  const picks = allowed.slice(0, Math.min(4, allowed.length));
Â  const per = Math.max(8, Math.round(totalTime / picks.length));
Â  function estimateMets(label){
Â  Â  if(label.includes('ä½')) return 4.0;
Â  Â  if(label.includes('ä¸­ä½')) return 4.5;
Â  Â  if(label.includes('ä¸­é«˜')) return 7.0;
Â  Â  if(label.includes('ä¸­ç­‰')) return 6.0;
Â  Â  if(label.includes('é«˜')) return 8.0;
Â  Â  return 5.0;
Â  }
Â  const mets = estimateMets(intensity);

Â  const recs = picks.map(e=>{
Â  Â  const duration = per;
Â  Â  const estCal = Math.round((mets * 3.5 * w / 200) * duration);
Â  Â  const metMin = Math.round(mets * duration);
Â  Â  return { equipment:e, duration, intensity, rpe, mets, metMin, estCal, reason:
Â  Â  Â  e==='è·‘æ­¥æ©Ÿ'?'è€—èƒ½é«˜ã€å¯æ§å¡åº¦èˆ‡é€Ÿåº¦':
Â  Â  Â  e==='æ©¢åœ“æ©Ÿ'?'ä½è¡æ“Šã€è†è“‹å‹å–„':
Â  Â  Â  e==='åˆ’èˆ¹æ©Ÿ'?'å…¨èº«å‹•å“¡ã€æé«˜è€—èƒ½':
Â  Â  Â  e==='ç«‹å¼è…³è¸è»Š'?'é©åˆé–“æ­‡ã€è†è“‹è² æ“”è¼ƒä½':
Â  Â  Â  e==='è‡¥å¼è…³è¸è»Š'?'éå¸¸ä½è¡æ“Šã€å¾©å¥èˆ‡å¿ƒè‚ºé©åˆ':'' };
Â  });

Â  prescriptionCard.style.display = 'block';
Â  rxSummary.innerHTML = `<div style="font-weight:800">${intensity} | ${rpe} | å»ºè­°ç¸½æ™‚é–“ ${totalTime} åˆ†é˜ | é ä¼° ${recs.reduce((s,r)=>s+r.estCal,0)} Kcal</div>
Â  Â  <div class="small" style="margin-top:6px">ç›®å‰æ¯é€± ${currDays} å¤©ï¼Œé æœŸæ¯é€± ${futureDays} å¤©ï¼›ç›®æ¨™ ${answers.goal || 'ç¶­æŒ'}ï¼›ç›®æ¨™æœŸç¨‹ ${weeks} é€±ã€‚</div>`;

Â  rxPlan.innerHTML = `<div class="small">è™•æ–¹åŸå‰‡ï¼š${chronic || knee || asthma ? 'å› å¥åº·å› ç´ ï¼Œæ¡ç”¨ä¿å®ˆè™•æ–¹ï¼Œå»ºè­°å„ªå…ˆä½¿ç”¨' + picks[0] : 'ç‚ºæé«˜é‹å‹•æ•ˆç›Šï¼Œå»ºè­°æ¡ç”¨ä¸‹åˆ—å™¨æçµ„åˆ'}</div>`;

Â  // save last generated
Â  const last = { recs, summary:{intensity,rpe,totalTime,mets}, answers, date: new Date().toISOString().split('T')[0], ts: Date.now() };
Â  localStorage.setItem('tsox_lastGenerated', JSON.stringify(last));
Â  
Â  const todayKey = new Date().toISOString().split('T')[0];
Â  const todayEvents = loadCalendar()[todayKey] || [];
Â  
Â  renderRecommendationList(recs, todayEvents, todayKey);

Â  renderCalendar(); renderWeekChart(); renderWeekChartSmall();
}

function renderRecommendationList(recs, todayEvents, todayKey){
Â  recommendList.innerHTML = '';
Â  recs.forEach((r, idx)=>{
Â  Â  const isAdded = todayEvents.some(e => e.plan && e.plan.some(p => p.equipment === r.equipment));
Â  Â  const div = document.createElement('div');
Â  Â  div.className = 'reco-card';
Â  Â  
Â  Â  const btnClass = isAdded ? 'button added-btn' : 'button';
Â  Â  const btnText = isAdded ? 'âœ“ å·²åŠ å…¥' : 'åŠ å…¥è¡Œäº‹æ›†';
Â  Â  const btnAction = isAdded ? `showDayEvents('${todayKey}')` : `addToCalendarFromBtn(this, ${JSON.stringify(r).replace(/'/g,"\\'")})`;
Â  Â  
Â  Â  div.innerHTML = `
Â  Â  Â  <div class="reco-left">
Â  Â  Â  Â  <div style="font-weight:800">${r.equipment} <button class="button ghost" style="margin-left:8px;padding:6px 8px" data-equip="${r.equipment}" onclick="showEquipFromBtn(event)">?</button></div>
Â  Â  Â  Â  <div class="reco-meta">æ™‚é–“ï¼š${r.duration} åˆ†é˜ | ${r.intensity} | ${r.rpe} | METs: ${r.mets} | MET-min: ${r.metMin} | kcal: ${r.estCal}</div>
Â  Â  Â  Â  <div class="small" style="margin-top:4px;color:#00838f">${r.reason}</div>
Â  Â  Â  </div>
Â  Â  Â  <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-end">
Â  Â  Â  Â  <button class="${btnClass}" data-added="${isAdded}" id="recoBtn${idx}" onclick='${btnAction}'>${btnText}</button>
Â  Â  Â  </div>
Â  Â  `;
Â  Â  recommendList.appendChild(div);
Â  });
Â  
Â  const allAdded = recs.every(r => todayEvents.some(e => e.plan && e.plan.some(p => p.equipment === r.equipment)));
Â  addAllBtn.disabled = allAdded;
Â  addAllBtn.textContent = allAdded ? 'å…¨éƒ¨è™•æ–¹å·²åŠ å…¥è¡Œäº‹æ›†' : 'ä¸€éµåŠ å…¥å…¨éƒ¨è™•æ–¹åˆ°ä»Šæ—¥è¡Œäº‹æ›†';
Â  addAllBtn.classList.toggle('added-btn', allAdded);
}

function addToCalendarFromBtn(buttonEl, r){
Â  addSingleToCalendar(r);
Â  buttonEl.textContent = 'âœ“ å·²åŠ å…¥';
Â  buttonEl.classList.add('added-btn');
Â  buttonEl.setAttribute('data-added', 'true');
Â  buttonEl.onclick = ()=> {showDayEvents(new Date().toISOString().split('T')[0]); showToast(`å·²åˆ‡æ›è‡³ä»Šæ—¥ç´€éŒ„`);};
Â  showToast(`${r.equipment} å·²åŠ å…¥è¡Œäº‹æ›†`);
}

function showEquipFromBtn(ev){ const name = ev.currentTarget.getAttribute('data-equip'); showEquipInfoByName(name); }

/* ---------- calendar operations (retained) ---------- */
function loadCalendar(){ return JSON.parse(localStorage.getItem('tsox_calendar') || '{}'); }
function saveCalendarObj(obj){ localStorage.setItem('tsox_calendar', JSON.stringify(obj)); }
function addToCalendar(entry, dateKey){
Â  const cal = loadCalendar();
Â  if(!cal[dateKey]) cal[dateKey] = [];
Â  cal[dateKey].push(entry);
Â  saveCalendarObj(cal);
Â  log('å·²åŠ å…¥è¡Œäº‹æ›†ï¼š' + dateKey);
Â  renderCalendar(); renderWeekChart(); renderWeekChartSmall();
}
function addSingleToCalendar(r){
Â  const dateKey = new Date().toISOString().split('T')[0];
Â  const entry = {
Â  Â  title: r.equipment, totalTime: r.duration, mets: r.mets, metMin: r.metMin, estCal: r.estCal, plan: [r], answers, date: dateKey, ts: Date.now()
Â  };
Â  addToCalendar(entry, dateKey);
}

addAllBtn.addEventListener('click', ()=>{
Â  const raw = localStorage.getItem('tsox_lastGenerated');
Â  if(!raw) { alert('è«‹å…ˆå®Œæˆå•è¨ºç”Ÿæˆè™•æ–¹ã€‚'); return; }
Â  const lastGenerated = JSON.parse(raw);
Â  const todayKey = new Date().toISOString().split('T')[0];
Â  const todayEvents = loadCalendar()[todayKey] || [];
Â  
Â  let addedCount = 0;
Â  lastGenerated.recs.forEach((r) => {
Â  Â  const isAdded = todayEvents.some(e => e.plan && e.plan.some(p => p.equipment === r.equipment));
Â  Â  if(!isAdded) { const entry = { title: r.equipment, totalTime: r.duration, mets: r.mets, metMin: r.metMin, estCal: r.estCal, plan: [r], answers: lastGenerated.answers, date: todayKey, ts: Date.now() }; addToCalendar(entry, todayKey); addedCount++; }
Â  });
Â  
Â  if (addedCount > 0) {
Â  Â  showToast(`å·²å°‡ ${addedCount} é …è™•æ–¹åŠ å…¥ä»Šå¤©è¡Œäº‹æ›†ï¼`);
Â  Â  renderRecommendationList(lastGenerated.recs, loadCalendar()[todayKey] || [], todayKey);
Â  } else { showToast('ä»Šæ—¥è™•æ–¹éƒ½å·²ç¶“åœ¨è¡Œäº‹æ›†ä¸­äº†ã€‚'); }
});


/* --- export & delete --- */
function exportAllGenerated(){
Â  const raw = localStorage.getItem('tsox_lastGenerated');
Â  if(!raw) { alert('å°šç„¡è™•æ–¹å¯åŒ¯å‡º'); return; }
Â  const data = JSON.parse(raw);
Â  const dateKey = data.date || new Date().toISOString().split('T')[0];
Â  const totalMetMin = (data.recs||[]).reduce((s,r)=>s+(r.metMin||0),0);
Â  const totalKcal = (data.recs||[]).reduce((s,r)=>s+(r.estCal||0),0);
Â  const content = `
Â  Â  <html><head><meta charset="utf-8"><title>æœ¬æ¬¡è™•æ–¹ç¸½åŒ¯ ${dateKey}</title><style>body{font-family:'Noto Sans TC',Arial,Helvetica,sans-serif;padding:20px}h2{color:#2e7d32}li{margin-bottom:8px}table{width:100%;border-collapse:collapse}th,td{border:1px solid #ddd;padding:8px;text-align:left}th{background:#f5f5f5}</style></head><body>
Â  Â  <h2>T-SOX æ•™ç·´è™•æ–¹ç¸½åŒ¯</h2><div>æ—¥æœŸï¼š${dateKey}</div><div>ç¸½çµï¼š${data.summary.intensity} | ç¸½æ™‚é–“ ${data.summary.totalTime} åˆ†é˜ | ${data.summary.rpe}</div><h3>åˆ†é …å»ºè­°</h3><table><thead><tr><th>å™¨æ</th><th>æ™‚é–“</th><th>å¼·åº¦</th><th>METs</th><th>MET-min</th><th>é ä¼° Kcal</th></tr></thead><tbody>${data.recs.map(r=>`<tr><td>${r.equipment}</td><td>${r.duration} åˆ†é˜</td><td>${r.intensity} (${r.rpe})</td><td>${r.mets}</td><td>${r.metMin}</td><td>${r.estCal}</td></tr>`).join('')}</tbody></table><h3>å•è¨ºæ‘˜è¦ï¼ˆä¾æ­¤é–‹ç«‹è™•æ–¹ï¼‰</h3><pre>${formatAnswersForExport(data.answers)}</pre></body></html>`;
Â  Â  
Â  const w = window.open('','_blank'); w.document.write(content); w.document.close(); setTimeout(()=> w.print(),600);
}

function formatAnswersForExport(ans){
Â  if(!ans) return '';
Â  let s = '';
Â  s += `æ€§åˆ¥ï¼š${ans.gender==='male'?'ç”·æ€§':'å¥³æ€§'}\n`; s += `å¹´é½¡ï¼š${ans.age||''}\n`; s += `èº«é«˜ï¼š${ans.height||''}\n`;
Â  s += `é«”é‡ï¼š${ans.weight||''}\n`; s += `é‹å‹•ç›®æ¨™ï¼š${ans.goal||''}\n`; s += `ç›®å‰æ¯é€±é‹å‹•ï¼š${ans.current_days||''}\n`;
Â  s += `æœªä¾†æ¯é€±ç›®æ¨™ï¼š${ans.future_days||''}\n`; s += `ç¶“é©—ï¼š${ans.experience||''}\n`; s += `æ…¢æ€§ç—…ï¼š${ans.chronic==='yes'?'æœ‰':'æ²’æœ‰'} ${ans.chronic_type||''}\n`;
Â  s += `æ°£å–˜ï¼š${ans.asthma==='yes'?'æœ‰':'æ²’æœ‰'}\n`; s += `è†è“‹ï¼š${ans.knee==='yes'?'æœ‰':'æ²’æœ‰'}\n`; s += `ç›®æ¨™é€±æ•¸ï¼š${ans.goal_weeks||''}\n`;
Â  return s;
}

function deleteSingle(dateKey, idx){
Â  if(!confirm('ç¢ºå®šåˆªé™¤æ­¤ç­†ç´€éŒ„ï¼Ÿ')) return;
Â  const cal = loadCalendar();
Â  cal[dateKey].splice(idx,1);
Â  if(cal[dateKey].length === 0) delete cal[dateKey];
Â  saveCalendarObj(cal);
Â  renderCalendar(); showDayEvents(dateKey); renderWeekChart(); renderWeekChartSmall();
}

/* ---------- chart functions (retained) ---------- */
function getWeekNumber(d){
Â  d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
Â  const dayNum = d.getUTCDay() || 7;
Â  d.setUTCDate(d.getUTCDate() + 4 - dayNum);
Â  const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
Â  return Math.ceil((((d - yearStart) / 86400000) + 1)/7);
}
function aggregateWeeklyMetMin(){
Â  const cal = loadCalendar();
Â  const weekly = {};
Â  for(const dateKey in cal){
Â  Â  const items = cal[dateKey];
Â  Â  items.forEach(it=>{
Â  Â  Â  const d = new Date(dateKey); const y = d.getFullYear(); const w = getWeekNumber(d); const ky = `${y}-W${String(w).padStart(2,'0')}`;
Â  Â  Â  const val = Number(it.metMin || 0); weekly[ky] = (weekly[ky] || 0) + val;
Â  Â  });
Â  }
Â  const keys = Object.keys(weekly).sort(); return {keys, values: keys.map(k=>weekly[k])};
}
function renderWeekChart(){
Â  const agg = aggregateWeeklyMetMin();
Â  if(!weekChart){ weekChart = new Chart(weekCtx, { type:'line', data:{ labels: agg.keys, datasets:[{ label:'æ¯é€± MET-min', data: agg.values, fill:false, tension:0.2, borderColor:'#2e7d32', backgroundColor:'#2e7d32' }] }, options:{ responsive:true, maintainAspectRatio: false, scales:{ y:{ beginAtZero:true } } } }); } 
Â  else { weekChart.data.labels = agg.keys; weekChart.data.datasets[0].data = agg.values; weekChart.update(); }
}
function renderWeekChartSmall(){
Â  const agg = aggregateWeeklyMetMin();
Â  if(!weekChartSmall){ weekChartSmall = new Chart(weekCtxSmall, { type:'line', data:{ labels: agg.keys, datasets:[{ label:'æ¯é€± MET-min', data: agg.values, fill:false, tension:0.2, borderColor:'#ff6f00', backgroundColor:'#ff6f00' }] }, options:{ responsive:true, maintainAspectRatio: false, scales:{ y:{ beginAtZero:true } }, plugins:{ legend:{display:false} } }); } 
Â  else { weekChartSmall.data.labels = agg.keys; weekChartSmall.data.datasets[0].data = agg.values; weekChartSmall.update(); }
}

/* ---------- Calendar UI & Events ---------- */
function renderCalendar(){
Â  const year = viewDate.getFullYear(), month = viewDate.getMonth();
Â  calHeader.innerText = `${year} / ${month+1}`;
Â  calGrid.innerHTML = '';
Â  const first = new Date(year, month, 1);
Â  const start = first.getDay();
Â  const dim = new Date(year, month+1, 0).getDate();
Â  const cal = loadCalendar();
Â  const dayNames = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];
Â  dayNames.forEach(name => { const dayCell = document.createElement('div'); dayCell.className = 'cal-cell'; dayCell.style.fontWeight = 'bold'; dayCell.style.background = '#f5f5f5'; dayCell.style.minHeight = '30px'; dayCell.innerHTML = name; calGrid.appendChild(dayCell); });
Â  for(let i=0;i<start;i++){ const blank = document.createElement('div'); blank.className='cal-cell'; blank.style.minHeight='80px'; calGrid.appendChild(blank); }
Â  for(let d=1; d<=dim; d++){
Â  Â  const dateKey = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
Â  Â  const events = cal[dateKey] || [];
Â  Â  const cell = document.createElement('div'); 
Â  Â  const totalMetMin = events.reduce((s,e)=>s + (e.metMin || 0),0); const totalKcal = events.reduce((s,e)=>s + (e.estCal || 0),0);
Â  Â  cell.innerHTML = `<div class="dateNum">${d}</div>` + (events.length>0 ? `<div class="small">${events.length} ç­†</div><div class="small">MET-min:${Math.round(totalMetMin)}</div><div class="small">Kcal:${Math.round(totalKcal)}</div>` : '');
Â  Â  if(events.length>0) cell.classList.add('has');
Â  Â  const dot = document.createElement('div'); dot.className='cal-dot'; cell.appendChild(dot);
Â  Â  cell.addEventListener('click', ()=> showDayEvents(dateKey));
Â  Â  calGrid.appendChild(cell);
Â  }
}
function showDayEvents(dateKey){
Â  const cal = loadCalendar(); const events = cal[dateKey] || []; let html = `<div style="font-weight:800;margin-bottom:8px">${dateKey}</div>`;
Â  if(events.length===0) html += '<div class="small">ç•¶æ—¥ç„¡ç´€éŒ„</div>';
Â  else { events.forEach((e, idx)=>{ html += `<div style="border-bottom:1px dashed #eee;padding-bottom:8px;margin-bottom:8px"><div style="font-weight:800">${e.title || e.plan?.[0]?.equipment || 'è™•æ–¹'}</div><div class="small">æ™‚é–“ï¼š${e.totalTime || e.plan?.[0]?.duration || ''} åˆ†é˜ | METsï¼š${e.mets || e.plan?.[0]?.mets || ''} | MET-min ${Math.round(e.metMin|| (e.mets* (e.totalTime|| e.plan?.[0]?.duration || 0)))} | kcalï¼š${Math.round(e.estCal|| e.plan?.[0]?.estCal || 0)}</div><div style="margin-top:8px;display:flex;gap:8px"><button class="button ghost" onclick='exportSingle("${dateKey}", ${idx})'>åŒ¯å‡º PDF</button><button class="button" style="background:#d32f2f" onclick='deleteSingle("${dateKey}", ${idx})'>åˆªé™¤</button></div></div>`; }); }
Â  dayEvents.innerHTML = html;
}

/* ---------- Navigation & Scrolling ---------- */
function navTo(p){
Â  document.querySelectorAll('.nav-btn').forEach(n=>n.classList.remove('active'));
Â  document.querySelectorAll('.tab-page').forEach(tp=>tp.classList.remove('active'));
Â  if(p==='survey'){ document.getElementById('tabSurveyBtn').classList.add('active'); document.getElementById('page-survey').classList.add('active'); window.scrollTo({top:0,behavior:'smooth'}); }
Â  if(p==='calendar'){ document.getElementById('tabCalendarBtn').classList.add('active'); document.getElementById('page-calendar').classList.add('active'); window.scrollTo({top:document.getElementById('calendarSection').offsetTop,behavior:'smooth'}); }
Â  if(p==='met'){ document.getElementById('tabMetBtn').classList.add('active'); document.getElementById('page-met').classList.add('active'); window.scrollTo({top:document.getElementById('chartSection').offsetTop,behavior:'smooth'}); }
}

/* ---------- Final Init & Event Handlers ---------- */
function initAppListeners(){
Â  // Attach mic buttons to start diagnosis
Â  document.getElementById('micBtn').addEventListener('click', ()=> startDiagnosis(currentLang));
Â  micZhBtn.addEventListener('click', ()=> { currentLang='cmn-Hant-TW'; micZhBtn.classList.add('active'); micTwBtn.classList.remove('active'); showToast('åˆ‡æ›ï¼šè¯èªè­˜åˆ¥'); });
Â  micTwBtn.addEventListener('click', ()=> { currentLang='zh-TW'; micTwBtn.classList.add('active'); micZhBtn.classList.remove('active'); showToast('åˆ‡æ›ï¼šå°èªè­˜åˆ¥'); });
Â  
Â  // Initial render
Â  window.onload = ()=>{
Â  Â  renderCalendar(); renderWeekChart(); renderWeekChartSmall();
Â  }
}
initAppListeners();
</script>
</body>
</html>
